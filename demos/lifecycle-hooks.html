<!doctype html>
<html>
<head>
	<title>domvm lifecycle hooks</title>
	<style>
		.view1,
		.view1 li {
			background: transparent;
			transition: 1000ms;
			opacity: 1;
		}

		.view1.mounted {
			outline: 2px solid red;
			transition: none;
		}

		.view1.redrawn {
			background: lightblue;
			transition: none;
		}

		.view1.unmounting {
			background: pink;
			transition: none;
		}

		.view1.unmounted {
			opacity: 0;
		}

		.view1 .inserted {
			background: lime;
			transition: none;
		}

		.view1 .removing {
			background: red;
			transition: none;
		}

		.view1 .removed {
			opacity: 0;
		}

		.view1 .reused.same {
			background: silver;
			transition: none;
		}

		.view1 .reused.changed {
			background: orange;
			transition: none;
		}

		.view1 .moved {
			background: magenta;
			transition: none;
		}
	</style>

	<script src="../dist/polyfills.min.js"></script>

	<script src="../src/domvm.js"></script>
	<script src="../src/util.js"></script>
	<script src="../src/view.js"></script>
</head>
<body>
	<script>
		function View1(vm, data) {
			// DOM node/template level hooks
			var hooks = {
				willInsert: function(node) {
					console.log("willInsert", node);
				},
				didInsert: function(node) {
					console.log("didInsert", node);

					node.el.classList.add("inserted");
					requestAnimationFrame(function() {
						node.el.classList.remove("inserted");
					});
				},
				willRecycle: function(oldNode, newNode) {
					console.log("willRecycle", oldNode, newNode);
				},
				didRecycle: function(oldNode, newNode) {
					console.log("didRecycle", oldNode, newNode);

					// DIY diff to detect changes
					if (oldNode.body !== newNode.body) {
						newNode.el.classList.add("reused", "changed");
						requestAnimationFrame(function() {
							newNode.el.classList.remove("reused", "changed");
						});
					}
				},
				willReinsert: function(node) {
					console.log("willReinsert", node);
				},
				didReinsert: function(node) {
					console.log("didReinsert", node);

					node.el.classList.add("moved");
					requestAnimationFrame(function() {
						node.el.classList.remove("moved");
					});
				},
				willRemove: function(node) {
					console.log("willRemove", node);

					node.el.classList.add("removing");
					requestAnimationFrame(function() {
						node.el.classList.remove("removing");
						node.el.classList.add("removed");
					});

					return new Promise(function(resolve, reject) {
						node.el.addEventListener("transitionend", resolve);
					});
				},
				didRemove: function(node) {
					console.log("didRemove", node);
				},
			};

			return function() {
				return (
					[".view1",
						["ul", data.map(function(word) {
							return ["li", {_hooks: hooks, _key: word.substr(0,1)}, word];
						})],
						[View2],
					]
				);
			};
		}

		function View2(vm) {
			vm.hook({
				willRedraw: function() { console.log("willRedraw", vm); },
				didRedraw: function() { console.log("didRedraw", vm); },
				willMount: function() { console.log("willMount", "View2", vm); },
				didMount: function() { console.log("didMount", "View2", vm); },
				willUnmount: function() { console.log("willUnmount", vm); },
				didUnmount: function() { console.log("didUnmount", vm); },
			});

			return function() {
				return ["p.view2", "Hello World"];
			};
		}

		var data = [
			"0.cat",
			"1.dog",
		];

		var vm = domvm.view(View1, data);

		// view-level hooks
		vm.hook({
			willRedraw: function() { console.log("willRedraw", vm); },
			didRedraw: function() {
				console.log("didRedraw", vm);

				vm.node.el.classList.add("redrawn");
				requestAnimationFrame(function() {
					vm.node.el.classList.remove("redrawn");
				});
			},
			willMount: function() {
				console.log("willMount", vm);
			},
			didMount: function() {
				console.log("didMount", vm);

				vm.node.el.classList.add("mounted");
				requestAnimationFrame(function() {
					vm.node.el.classList.remove("mounted");
				});
			},
			willUnmount: function() {
				console.log("willUnmount", vm);

				vm.node.el.classList.add("unmounting");
				requestAnimationFrame(function() {
					vm.node.el.classList.remove("unmounting");
					vm.node.el.classList.add("unmounted");
				});

				return new Promise(function(resolve, reject) {
					vm.node.el.addEventListener("transitionend", resolve);
				});
			},
			didUnmount: function() { console.log("didUnmount", vm); },
		});

		vm.mount(document.body);

		setTimeout(function() {
			data.pop();
			vm.redraw();
		}, 1000);

		setTimeout(function() {
			data.push("2.foo","3.bar");
			vm.redraw();
		}, 2000);

		setTimeout(function() {
			data.unshift(data.pop());
			vm.redraw();
		}, 3000);

		setTimeout(function() {
			data.splice(2, 0, "4.cookie");
			data.splice(0, 1, "5.butter");
			vm.redraw();
		}, 4000);

		setTimeout(function() {
			data[0] += "-mod";
			data[2] += "-mod";
			vm.redraw();
		}, 5000);
/*
		setTimeout(function() {
			vm.unmount();
		}, 6000);
*/
	</script>
</body>
</html>